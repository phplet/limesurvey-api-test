<!DOCTYPE html>
<html>
    <head>
        <!-- HTML Setup -->
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <!-- Semantic -->
        <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.12.0/semantic.min.css">
        <!-- Loading Bar -->
        <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/angular-loading-bar/0.7.1/loading-bar.min.css">
        <!-- Fonts -->
        <link href='https://fonts.googleapis.com/css?family=Ubuntu:400,700' rel='stylesheet' type='text/css'>
        <link href='https://fonts.googleapis.com/css?family=Raleway:400,700' rel='stylesheet' type='text/css'>
        <style type="text/css">
            html, body { font-family: 'Ubuntu', serif; }
            .page.grid .column { margin-bottom: 120px; }
            .test_details_show { height: 100%; }
            .test_details_hide { height: 0%; }
            .messages_padding { padding: 10px 0; }
            .messages { padding: 10px 0; }
        </style>

            <title>LimeSurvery Tests</title>
    </head>

    <body ng-app="testsApp" ng-controller="testsCtrl">

        <div class="pusher">



                <!-- ####################  MENU  #################### -->


            <div class="ui fixed main menu grid">
                <div class="item">
                    LimeSurvey API Test
                </div>
            </div>



                <!-- ####################  PAGE  #################### -->


            <div class="ui page grid">
                <div class="column">


                <!-- ###############  SEGMENT  ############### -->

                    <div class="ui segment" id="segment_tests">


                            <!-- ##########  MESSAGES  ########## -->

                        <div class="messages_padding">
                            <div ng-repeat="(key, value) in messages" class="messages">
                                <div class="ui {{ value.type }} message">
                                    <i class="close icon" ng-click="removeMessage(key)"></i>
                                    <span ng-bind-html="value.message"></span>
                                </div>
                            </div>
                        </div>


                            <!-- ##########  TABLE  ########## -->

                        <table class="ui striped table">
                            <thead>
                                <tr>
                                    <th>Status</th>
                                    <th>Test Name</th>
                                    <th>Command</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>

                                <!-- ##########  COLUMNS  ########## -->

                            <tbody ng-repeat="result in data.results">
                                <tr>
                                    <td class="center aligned {{ result.status.class }}">{{ result.status.text }}</td>
                                    <td class="info">{{ result.name }}</td>
                                    <td><code>{{ result.method }}</code></td>
                                    <td>
    <!--                                     <button class="ui green button" ng-click="runTest(result)">Run Test</button>
                                        <button class="ui button" ng-show="result.response" ng-click="showDetails = !showDetails"> -->
                                        <button class="ui green mini icon button"><i class="arrow right icon" ng-click="runTest(result)"></i></button>
                                        <button class="ui mini icon button" ng-show="result.response" ng-click="showDetails = !showDetails"><i class="info icon"></i></button>
                                    </td>
                                </tr>
                                <tr ng-init="showDetails = false" ng-show="showDetails">
                                    <td colspan="4">

                                            <!-- #####  DETAILS ##### -->

                                        <table class="ui very basic table" style="table-layout: fixed;">
                                            <tr>
                                                <td><b>Status: </b></td>
                                                <td style="word-wrap:break-word;" width="80%"><code>{{ result.response.status }}</code></td>
                                            </tr>
                                            <tr>
                                                <td><b>post: </b></td>
                                                <td style="word-wrap:break-word;"><code>{{ result.response.post }}</code></td>
                                            </tr>
                                            <tr>
                                                <td><b>data: </b></td>
                                                <td style="word-wrap:break-word;"><code>{{ result.response.data }}</code></td>
                                            </tr>
                                        </table>

                                    </td>
                                </tr>
                            </tbody>
                            <!--<tfoot>
                                <tr><th>3 People</th>
                                    <th>2 Approved</th>
                                    <th></th>
                                </tr>
                            </tfoot>-->
                        </table>

                    </div><!-- END: Segment -->

                </div><!-- END: Column -->

            </div><!-- END: Grid -->

        </div><!-- END: Pusher -->



                <!-- ####################  FOOTER  #################### -->


        <div class="ui visible one item bottom menu sidebar overlay">

                <!-- ##########  PROGRESSBAR  ########## -->

            <div class="ui top attached progress" id="allTestsProgress">
                <div class="bar"></div>
            </div>

            <div class="item">
                <div class="ui grid" style="margin: 0 20px;">
                    <div class="column">

                            <!-- ##########  BUTTON  ########## -->

                        <button class="ui green huge fluid button" ng-click="runAllTests()" style="margin-right: 20px;">
                            Run All Tests
                        </button>

                    </div>
                </div>
            </div>
        </div>



            <!-- ####################  SCRIPTS  #################### -->


        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.3.15/angular.min.js"></script>
        <!-- <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script> -->
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.3/jquery.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/1.12.0/semantic.min.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/modernizr/2.8.3/modernizr.min.js"></script>

        <script type="text/javascript">

            $('.ui.sidebar').sidebar();

            // Create Base64 Object > (https://scotch.io/quick-tips/how-to-encode-and-decode-strings-with-base64-in-javascript)
            var Base64={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",encode:function(e){var t="";var n,r,i,s,o,u,a;var f=0;e=Base64._utf8_encode(e);while(f<e.length){n=e.charCodeAt(f++);r=e.charCodeAt(f++);i=e.charCodeAt(f++);s=n>>2;o=(n&3)<<4|r>>4;u=(r&15)<<2|i>>6;a=i&63;if(isNaN(r)){u=a=64}else if(isNaN(i)){a=64}t=t+this._keyStr.charAt(s)+this._keyStr.charAt(o)+this._keyStr.charAt(u)+this._keyStr.charAt(a)}return t},decode:function(e){var t="";var n,r,i;var s,o,u,a;var f=0;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");while(f<e.length){s=this._keyStr.indexOf(e.charAt(f++));o=this._keyStr.indexOf(e.charAt(f++));u=this._keyStr.indexOf(e.charAt(f++));a=this._keyStr.indexOf(e.charAt(f++));n=s<<2|o>>4;r=(o&15)<<4|u>>2;i=(u&3)<<6|a;t=t+String.fromCharCode(n);if(u!=64){t=t+String.fromCharCode(r)}if(a!=64){t=t+String.fromCharCode(i)}}t=Base64._utf8_decode(t);return t},_utf8_encode:function(e){e=e.replace(/\r\n/g,"\n");var t="";for(var n=0;n<e.length;n++){var r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r)}else if(r>127&&r<2048){t+=String.fromCharCode(r>>6|192);t+=String.fromCharCode(r&63|128)}else{t+=String.fromCharCode(r>>12|224);t+=String.fromCharCode(r>>6&63|128);t+=String.fromCharCode(r&63|128)}}return t},_utf8_decode:function(e){var t="";var n=0;var r=c1=c2=0;while(n<e.length){r=e.charCodeAt(n);if(r<128){t+=String.fromCharCode(r);n++}else if(r>191&&r<224){c2=e.charCodeAt(n+1);t+=String.fromCharCode((r&31)<<6|c2&63);n+=2}else{c2=e.charCodeAt(n+1);c3=e.charCodeAt(n+2);t+=String.fromCharCode((r&15)<<12|(c2&63)<<6|c3&63);n+=3}}return t}}

            // Angular's implementation of JSON-RPC > (http://ngmodules.org/modules/angularjs-json-rpc)
            angular.module("JSON-RPC",[]).config(["$provide",function(a){return a.decorator("$http",["$delegate",function(a){return a.jsonrpc=function(b,c,d,e){var f={jsonrpc:"2.0",method:c,params:d,id:1};return a.post(b,f,angular.extend({headers:{"Content-Type":"application/json"}},e))},a}])}]);

            // Angular
            var app = angular.module('testsApp', ['JSON-RPC']);
            app.controller('testsCtrl', function($scope, $http, $q, $sce) {

                $scope.progressMessage = 'Tests Completed';

                // has to go here because otherwise the initial messages won't be added
                showMessage = function(messageType, message) {
                    $scope.messages.push({'type':messageType,'message':$sce.trustAsHtml(message)});
                }

                // Initial message
                $scope.messages = [];
                showMessage('info','Please use Chrome to run these tests');
                showMessage('info','Please log into your instance of LimeSurvery for the <code>get_survey_as_XML</code> test to work');


                // populates the table on startup
                $http.get("limesurvey_api_functions_as_JSON.php")
                .success(function(response) {
                    // add the default status to the test
                    for (i = 0; i < response.results.length; i++) {
                        response.results[i].status = {'text':'Not Run','class':'active'};
                    }
                    // initalise the progressbar
                    //$('#allTestsProgress').progress({'total':response.results.length,'text':{'active':'Running {value} of {total} tests'}});
                    $('#allTestsProgress').progress({'total':response.results.length});
                    // store the data locally for angular to loop through
                    $scope.data = response;
                });

                $scope.testsFailed = 0;

                // run the test suite
                $scope.runAllTests = function() {
                    $('#allTestsProgress').addClass('success');
                    var currentFunctionIndex = 0;
                    function nextTest() {
                        if (currentFunctionIndex < $scope.data.results.length) {
                            $scope.runTest($scope.data.results[currentFunctionIndex++]).then(nextTest);
                            $('#allTestsProgress').progress('increment');
                            $scope.progressMessage = 'Running ' + currentFunctionIndex + ' of ' + $scope.data.results.length + 'tests';
                        // last test
                        } else {
                            // if there was an error turn the progressbar red
                            if($scope.testsFailed > 0) {
                                $('#allTestsProgress').addClass('error');
                                $scope.progressMessage = 'Tests failed';
                            } else {
                                $scope.progressMessage = 'Tests completed successfully';
                            }
                        }
                    }
                    nextTest();
                }

                // test function
                $scope.runTest = function(result){
                    /// don't even ask ...
                    var deferred = $q.defer();

                            //////////  COPY SURVEY  //////////
                            // (it's not an API function)

                    if(result.method == 'get_survey_as_XML') {
                        // we have to get authenticated first
                        $http.post($scope.data.endPoints.login, {'authMethod':'Authdb','user':result.params.username,'password':result.params.password})
                        .success(function(data, status, headers, config) {
                            // then we can export the survey
                            $http.get($scope.data.endPoints.exportSurvey)
                            .success(function(data, status, headers, config) {
                                // get the exported survey name so we can use it later
                                var searchPattern  = new RegExp('\<surveyls_title\>.+\<\/surveyls_title\>');
                                surveyNameArray = searchPattern.exec(data);
                                newImportSurveyName = surveyNameArray[0];
                                if(newImportSurveyName.length > 1) {
                                    newImportSurveyName = newImportSurveyName.replace('<surveyls_title><![CDATA[','');
                                    // save survey name so we can duplicate it later
                                    $scope.newImportSurveyName = newImportSurveyName.replace(']]></surveyls_title>','');
                                    // save the data so we can import it later
                                    $scope.surveyAsBase64 = Base64.encode(data);
                                    testSuccess(result, data, status, deferred);
                                } else { testFailed(result, data, status, deferred); }
                            })
                            .error(function(data, status, headers, config) { testFailed(result, data, status, deferred); });
                        })
                        .error(function(data, status, headers, config) { testFailed(result, data, status, deferred); });

                            //////////  DEACTIVATE SURVEY  //////////
                            // (it's not an API function)
                            // NOTE: Doesn't work because of header problems with the second post action

                    } else if(result.method == 'deactivate_survey') {
                        // we have to get authenticated first
                        $http.post($scope.data.endPoints.login, {'authMethod':'Authdb','user':result.params.username,'password':result.params.password})
                        .success(function(data, status, headers, config) {
                            // then get the CSRF token
                            $http.get($scope.data.endPoints.deactivateSurvey)
                            .success(function(data, status, headers, config) {
                                // get the exported survey name so we can use it later
                                var searchPattern  = new RegExp('\<input type=\"hidden\" value=\".+\" name=\"YII_CSRF_TOKEN\" \/\>');
                                csrfToken = searchPattern.exec(data)[0];
                                if(csrfToken.length > 1) {
                                    csrfToken = csrfToken.replace('<input type="hidden" value="','');
                                    // save survey name so we can duplicate it later
                                    csrfToken = csrfToken.replace('" name="YII_CSRF_TOKEN" />','');
                                    // Then finally disable the survey
                                    console.log(JSON.stringify({'YII_CSRF_TOKEN':csrfToken,'action':'deactivate','ok':'Y','sid':$scope.data.surveyID}));
                                    $http.post($scope.data.endPoints.deactivateSurvey.replace('surveyid/',''), {'YII_CSRF_TOKEN':csrfToken,'action':'deactivate','ok':'Y','sid':$scope.data.surveyID})
                                    .success(function(data, status, headers, config) {
                                        testSuccess(result, data, status, deferred);
                                    })
                                    .error(function(data, status, headers, config) { testFailed(result, data, status, deferred); });
                                } else { testFailed(result, data, status, deferred); }
                            })
                            .error(function(data, status, headers, config) { testFailed(result, data, status, deferred); });
                        })
                        .error(function(data, status, headers, config) { testFailed(result, data, status, deferred); });

                            //////////  COPY GROUP  //////////
                            // (it's not an API function)

                    } else if(result.method == 'get_group_as_XML') {
                        // we have to get authenticated first
                        $http.post($scope.data.endPoints.login, {'authMethod':'Authdb','user':result.params.username,'password':result.params.password})
                        .success(function(data, status, headers, config) {
                            // then we can export the survey
                            $http.get($scope.data.endPoints.exportGroup)
                            .success(function(data, status, headers, config) {
                                // get the exported survey name so we can use it later
                                var searchPattern  = new RegExp('\<group_name\>.+\<\/group_name\>');
                                groupNameArray = searchPattern.exec(data);
                                newImportGroupName = groupNameArray[0];
                                if(newImportGroupName.length > 1) {
                                    // save survey name so we can duplicate it later
                                    $scope.newImportGroupName = newImportGroupName.replace('<group_name><![CDATA[','').replace(']]></group_name>','');  
                                    // save the data so we can import it later
                                    $scope.groupAsBase64 = Base64.encode(data);
                                    testSuccess(result, data, status, deferred);
                                } else { testFailed(result, data, status, deferred); }
                            })
                            .error(function(data, status, headers, config) { testFailed(result, data, status, deferred); });
                        })
                        .error(function(data, status, headers, config) { testFailed(result, data, status, deferred); });

                            //////////  COPY QUESTION  //////////
                            // (it's not an API function)

                    } else if(result.method == 'get_question_as_XML') {
                        // we have to get authenticated first
                        $http.post($scope.data.endPoints.login, {'authMethod':'Authdb','user':result.params.username,'password':result.params.password})
                        .success(function(data, status, headers, config) {
                            // then we can export the survey
                            $http.get($scope.data.endPoints.exportQuestion)
                            .success(function(data, status, headers, config) {
                                // get the exported survey name so we can use it later
                                var searchPattern  = new RegExp('\<question\>.+\<\/question\>');
                                questionNameArray = searchPattern.exec(data);
                                newImportQuestionName = questionNameArray[0];
                                if(newImportQuestionName.length > 1) {
                                    // save survey name so we can duplicate it later
                                    $scope.newImportQuestionName = newImportQuestionName.replace('<question><![CDATA[','').replace(']]></question>','');  
                                    // save the data so we can import it later
                                    $scope.questionAsBase64 = Base64.encode(data);
                                    testSuccess(result, data, status, deferred);
                                } else { testFailed(result, data, status, deferred); }
                            })
                            .error(function(data, status, headers, config) { testFailed(result, data, status, deferred); });
                        })
                        .error(function(data, status, headers, config) { testFailed(result, data, status, deferred); });


                    } else {

                            //////////  DYNAMICALLY REPLACE VALUES  //////////

                        // if the sessionKey is required get it from $scope
                        if(result.params.sSessionKey && result.params.sSessionKey == '<holder>') { result.params.sSessionKey = $scope.sessionKey; }
                        // if the surveyID is required get it from $scope
                        if(result.params.iSurveyID && result.params.iSurveyID == '<holder>') { result.params.iSurveyID = $scope.surveyId; }
                        // if the groupID is required get it from $scope
                        if(result.params.sGroupID && result.params.sGroupID == '<holder>') { result.params.sGroupID = $scope.groupId; }
                        // if the tokenID is required get it from $scope
                        if(result.params.sTokenID && result.params.sTokenID == '<holder>') { result.params.aTokenID = array($scope.tokenId); }

                                    ///// RPC FUNCTIONS (that import XML) /////

                        if(result.method == 'import_survey') {
                            result.params.sImportData = $scope.surveyAsBase64;
                            result.params.sNewSurveyName = $scope.newImportSurveyName + result.params.sNewSurveyName;
                        }

                        if(result.method == 'import_group') {
                            result.params.sImportData = $scope.groupAsBase64;
                            result.params.sNewGroupName = $scope.newImportGroupName + result.params.sNewGroupName;
                        }

                        // the JSON-RPC does not work so we have to mimic the real post
                        // (NOTE: this might cause a cross site error unless your on tha same surver)
                        if(result.method == 'import_question') {
                            sImportData = result.params.sImportData = $scope.questionAsBase64;
                            sNewQuestion = $scope.newImportQuestionName + result.params.sNewQuestion;

                            var boundary = "---------------------------7da24f2e50046";
                            var xhr = new XMLHttpRequest();
                            var body = '--' + boundary + '\r\n'
                            // Parameter name is "file" and local filename is "temp.txt"
                            + 'Content-Disposition: form-data; name="file";'
                            + 'filename="temp.txt"\r\n'
                            // Add the file's mime-type
                            + 'Content-type: plain/text\r\n\r\n'
                            + sImportData + '\r\n'
                            + boundary + '--';

                            xhr.open("POST", "https://www.mysite.com/myuploadhandler.php", true);
                            xhr.setRequestHeader("Content-type", "multipart/form-data; boundary=" + boundary);
                            xhr.onreadystatechange = function () {
                                if (xhr.readyState == 4 && xhr.status == 200) {
                                    console.log(xhr.responseText);
                                    deferred.resolve();
                                }
                            }
                            xhr.send(body);
                            deferred.resolve();
                        }


                        // test the method
                        $http.jsonrpc($scope.data.endPoints.remoteControl, result.method, result.params)
                        .success(function(data, status, headers, config) {
                            if(result.method == 'add_participant') {
                                console.log(data);
                            }
                            // if there are no errors
                            if (data.error === null && !data.result.status && data.result !== '') {

                                    /////  STORE RETURN VALUES  /////

                                // SESSION KEY: if it's the first test store the sessionKey for all subsquest tests
                                if(result.method == 'get_session_key') { $scope.sessionKey = data.result; }

                                // IMPORTED SURVEY KEY: stores the surveyID in $scope
                                if(result.method == 'add_survey' || result.method == 'import_survey') { $scope.surveyId = data.result; }

                                // GROUP KEY: stores the groupID in $scope
                                if(result.method == 'add_group' || result.method == 'import_group') { $scope.groupId = data.result; }

                                // QUESTION KEY: stores the questionID in $scope
                                if(result.method == 'import_question') { $scope.questionId = data.result; }

                                // TOKEN KEY: stores the participentID in $scope
                                if(result.method == 'add_participant') { $scope.tokenId = data.result.tid; }

                                // are we are looking for an expected result
                                if(result.expected) {
                                    // compaire the the returned value to the stored value
                                    if(JSON.stringify(result.expected) == JSON.stringify(data.result)) {
                                        testSuccess(result, data, status, deferred);
                                    } else {
                                        console.log('For \'' + result.method + '\ \'' + JSON.stringify(result.expected) + '\' was expected but \'' + JSON.stringify(data.result) + '\' was returned');
                                        testFailed(result, data, status, deferred);
                                    }
                                // it's just a normal test
                                } else {
                                    testSuccess(result, data, status, deferred);
                                }
                            } else {
                                if (data.result === null) {
                                    testFailed(result, data, status, deferred);
                                // the return value for 'delete_survey'
                                } else if(data.result.status == 'OK') {
                                    testSuccess(result, data, status, deferred);
                                // empty value returned
                                } else if(data.result.length == 0) {
                                    testWarning(result, data, status, deferred);
                                } else if (data.result.status == 'No available data') {
                                    testWarning(result, data, status, deferred);
                                } else {
                                    testFailed(result, data, status, deferred);
                                }
                            }
                        })
                        .error(function(data, status, headers, config){
                            testFailed(result, data, status, deferred);
                            
                        });
                    }
                    return deferred.promise;
                }

                testSuccess = function(result, data, status, deferred) {
                    updateTestStatus('success', result, data, status, deferred);
                }

                testWarning = function(result, data, status, deferred) {
                    updateTestStatus('warning', result, data, status, deferred);
                }

                testFailed = function(result, data, status, deferred) {
                    $scope.testsFailed++;
                    $('#allTestsProgress').addClass('error');
                    updateTestStatus('failed', result, data, status, deferred);
                }

                updateTestStatus = function(outcome, result, data, status, deferred) {
                    result.response = {'status':status, 'post':result.params, 'data':JSON.stringify(data)};
                    result.status.class = outcome;
                    if(outcome == 'success') { result.status.class = 'positive'; result.status.text = 'success'; }
                    else if(outcome == 'warning') { result.status.text = 'Empty Value';  result.status.class = 'warning'; }
                    else { result.status.class = 'negative'; result.status.text = 'failed'; }
                    deferred.resolve();
                }

                $scope.removeMessage = function(index){ $scope.messages.splice(index, 1); }
            });
        </script>
    </body>
</html>